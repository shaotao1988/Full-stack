

传统的数据库只能保证单个数据库数据修改的事务性，而在分布式系统中，为保证数据高可用和系统吞吐量，数据通常被分片和复制，存储在不同的物理机器上的不同数据库中，如何同步修改位于不同物理机器上的数据，是一个严峻的挑战。

解决分布式一致性问题比较著名的协议有2阶段提交(2PC, 2 Phase Commit)，3阶段提交(3PC，3 Phase Commit)和Paxo协议。

# 2PC

2阶段提交和3阶段提交都引入了事务协调者(XA Manager)的角色，对参与分布式事务的节点(XA Resource)的提交过程进行管理，保证事务的原子性(所有节点要么全做，要么全不做)。

1. 第一阶段：提交请求
   
   XA Manager向所有的XA Resource发起提交请求，XA Resource收到请求后获取相关资源，执行事务操作，并根据处理结果进行投票，向XA Manager发送OK或Abort应答。

2. 第二阶段：提交
   
   XA Manager收到所有XA Resource的应答后，进行第二阶段的操作。如果所有XA Resource都返回OK，则向所有XA Resource发送提交命令，否则发送回滚命令。XA Resource收到提交或回滚命令后完成提交或回滚并释放整个事务期间占用的资源。XA Manager收到所有XA Resource的提交完成或回滚完成的应答后，结束或取消事务。

2阶段提交的回滚是通过记录undo/redo日志来实现的。

2阶段提交看起来确实能提供原子性操作，但是仍有一些缺点：

- 阻塞
  2阶段提交是阻塞式协议，XA Resource在第一阶段应答完成后，将一直处于阻塞状态，直到收到第二阶段的提交或回滚命令。
- 数据不一致
  在第二阶段执行提交的过程中，如果XA Manager发送提交命令后宕机或者网络故障，导致只有一部分XA Resource接收到提交命令，那么就会有一部分XA Resource无法执行提交，整个分布式系统就出现了数据不一致的现象。
  另外，如果XA Manager发送提交命令后宕机，并且唯一接收到提交命令的XA Resource也宕机，那么即使通过选举产生了新的协调者，这条事务的状态也是不确定的：新的协调者无法确定已经宕机XA Resource是否已经完成提交，如果新的协调者发起提交，但是宕机的XA Resource并没有提交，数据就不一致了，反之亦然。
- 单点故障
  由于XA Manager在